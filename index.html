<!DOCTYPE html><html lang="zh"><head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NameNeko</title>
  <!-- Y2K 英文字体（中文会回退到雅黑） -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --pink:#f8d7dd; --bg:#fef4f8; --ink:#333; --card:#fff; --accent:#f497b6;
      --fs-label:11px; --fs-input:13px; --radius:12px; --gap:10px;
      /* 提示框（随主题变） */
      --tip-bg:#fff5f8; --tip-border:#f497b6; --tip-ink:#444;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:'Outfit','Microsoft YaHei',sans-serif; background:var(--bg); color:var(--ink); display:flex; justify-content:center; align-items:center; height:100vh }
    .phone{ width:360px; height:700px; background:var(--pink); border-radius:40px; box-shadow:0 0 20px rgba(0,0,0,.2); padding:20px; position:relative; overflow:hidden }
    .status-bar{ display:flex; justify-content:space-between; align-items:center; font-size:12px; padding:0 10px; color:#555 }.btn{ padding:10px 14px; font-size:14px; border:none; border-radius:10px; background:var(--accent); color:#fff; cursor:pointer; transition:transform .06s ease, box-shadow .2s ease }
.btn.secondary{ background:#c3c7d3; color:#222 }
.btn.small{ padding:6px 10px; font-size:12px }
.btn.wide{ width:100%; border-radius:14px }
.btn:active{ transform:translateY(1px) }

.icon-grid{ display:grid; grid-template-columns:repeat(3,1fr); gap:20px; margin-top:24px }
.app-icon{ display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--card); border-radius:20px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,.1); cursor:pointer; transition:transform .1s ease, box-shadow .2s ease, border .2s }
.app-icon:hover{ transform:scale(1.05) }
.app-icon img{ width:32px; height:32px; margin-bottom:8px }
.app-label{ font-size:13px; color:var(--ink) }

.screen{ display:none; height:calc(100% - 80px); overflow:auto; position:relative }
.visible{ display:block }

/* 生成器样式（始终双列） */
.generator{ padding:8px }
.generator-header{ display:flex; align-items:center; gap:8px; margin-bottom:8px }
.row{ display:grid; grid-template-columns:44% 56%; gap:var(--gap); align-items:end; margin-bottom:var(--gap) }
.field label{ font-size:var(--fs-label); color:#666; display:block; margin-bottom:6px; line-height:1.2 }
.field input, .field textarea{ width:100%; padding:8px 10px; border:1px solid #ddd; border-radius:var(--radius); font-size:var(--fs-input); background:#fff; color:#222 }
.field textarea{ resize:vertical }
.actions{ display:flex; flex-wrap:wrap; gap:10px; margin:14px 0 }
.tips{ font-size:11px; background:var(--tip-bg); border-left:4px solid var(--tip-border); padding:8px 10px; border-radius:10px; color:var(--tip-ink) }

/* 列表样式（库/收藏） */
.lib-tools{ display:flex; gap:8px; align-items:center; margin-left:auto }
.lib-search{ flex:1; padding:8px 10px; border:1px solid #ddd; border-radius:10px; background:#fff; font-size:13px }
.lib-list{ max-height:280px; overflow:auto }
.lib-item{ display:flex; gap:8px; align-items:center; background:#fff; border:1px solid #eee; border-radius:12px; padding:8px 10px; margin-bottom:8px }
.lib-title{ font-weight:600 }
.lib-meta{ font-size:11px; opacity:.7 }

/* 底部导出条 */
.bottom-bar{ position:sticky; bottom:0; left:0; right:0; padding:10px; background:rgba(248,215,221,.9); backdrop-filter:blur(4px); border-top-left-radius:14px; border-top-right-radius:14px }

/* ===== 主题预设（覆盖 CSS 变量即可全局换肤） ===== */
/* 水色 */
body.theme-aqua{ --pink:#cfe9f2; --bg:#eaf7fb; --ink:#233042; --card:#ffffff; --accent:#4fb0c6; --tip-bg:#eef9fd; --tip-border:#4fb0c6; --tip-ink:#244054; }
body.theme-aqua .bottom-bar{ background:rgba(207,233,242,.9) }

/* 雾绿 */
body.theme-green{ --pink:#d8f3dc; --bg:#effaf1; --ink:#1d3a2f; --card:#ffffff; --accent:#2d9d74; --tip-bg:#ecfbf0; --tip-border:#2d9d74; --tip-ink:#124332; }
body.theme-green .bottom-bar{ background:rgba(216,243,220,.9) }

/* Y2K 霓虹（玻璃拟态 + 霓虹渐变） */
body.theme-y2k{ --pink:radial-gradient(120% 120% at 20% 0%, #2e2a6d 0%, #17152e 55%, #0a0a14 100%); --bg:#0f0e1a; --ink:#eae8ff; --card:rgba(255,255,255,.06); --accent:#8ad7ff; --tip-bg:rgba(255,255,255,.08); --tip-border:#85f3ff; --tip-ink:#eae8ff; }
body.theme-y2k .phone{ box-shadow:0 0 0 1px rgba(255,255,255,.06), 0 20px 60px rgba(0,0,0,.6) }
body.theme-y2k .app-icon, body.theme-y2k .field input, body.theme-y2k .field textarea, body.theme-y2k .lib-item, body.theme-y2k .lib-search{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.16); backdrop-filter:blur(6px); color:var(--ink) }
body.theme-y2k .btn{ background:linear-gradient(135deg,#8a7dff,#85f3ff); box-shadow:0 0 10px rgba(138,125,255,.45), 0 0 18px rgba(133,243,255,.35) }
body.theme-y2k .app-icon:hover{ box-shadow:0 0 12px rgba(133,243,255,.25) }
body.theme-y2k .bottom-bar{ background:rgba(22,22,40,.86); border-top:1px solid rgba(255,255,255,.15) }

/* 夜间模式（独立开关，提示框也用变量） */
body.dark{ background:#1f1f2a; color:#f3f3f3; --tip-bg:#2a2a44; --tip-border:#a77aa3; --tip-ink:#ddd; }
body.dark .phone{ background:#2a2a3a }
body.dark .status-bar{ color:#bbb }
body.dark .app-icon{ background:#2f3044; box-shadow:0 2px 6px rgba(0,0,0,.4) }
body.dark .app-label{ color:#f0f0f0 }
body.dark .field label{ color:#ddd }
body.dark .field input, body.dark .field textarea{ background:#24243a; color:#f4f4f4; border-color:#3a3a58 }
body.dark .lib-item{ background:#2f3044; border-color:#3a3a58 }
body.dark .lib-search{ background:#24243a; color:#f4f4f4; border-color:#3a3a58 }
body.dark .bottom-bar{ background:rgba(42,42,58,.92) }
/* 如果是 Y2K 且开了夜间，仍然用 Y2K 的提示风格 */
body.theme-y2k.dark{ --tip-bg:rgba(255,255,255,.08); --tip-border:#85f3ff; --tip-ink:#eae8ff; }

@media (max-width: 360px){ :root{ --fs-label:10px; --fs-input:12px; --radius:10px; --gap:8px } .row{ grid-template-columns:46% 54% } }
/* —— 工具页按钮统一排版（Share & Token） —— */
#tools-screen .actions{
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 12px;
  margin-top: 12px;
}

/* 按钮统一高度/对齐 */
#tools-screen .actions .btn{
  width: 100%;
  height: 44px;
  border-radius: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  font-size: 14px;
  padding: 0 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,.08);
}

/* 覆盖 small，确保大小一致 */
#tools-screen .actions .btn.small{
  font-size: 14px;
  padding: 0 12px;
}

/* 超小屏改为一列 */
@media (max-width: 360px){
  #tools-screen .actions{ grid-template-columns: 1fr; }
}
:root{ --beige:#F8F1EB; }

/* === 全局：把灰按钮 .btn.secondary 换成低饱和奶油色 === */
:root{
  --cream-bg:   #FBF7F2;  /* 更浅的米白 */
  --cream-hover:#F6EFE8;  /* 悬停更浅一点 */
  --cream-bd:   #EFE7DF;  /* 边框 */
  --cream-fg:   #3A3734;  /* 文本：柔和深棕灰 */
}

.btn.secondary{
  background: var(--cream-bg);
  color: var(--cream-fg);
  border: 1px solid var(--cream-bd);
  box-shadow: 0 3px 10px rgba(0,0,0,.05);
  border-radius: 14px;      /* 统一圆角，可按需调 */
}
.btn.secondary:hover{ background: var(--cream-hover); }
.btn.secondary:active{ transform: translateY(1px); box-shadow: 0 2px 6px rgba(0,0,0,.06); }

/* 夜间模式下的奶油风对照色（不显脏灰） */
body.dark .btn.secondary{
  background: #2E2A27;      /* 深咖底 */
  color: #F5ECE4;           /* 奶白字 */
  border-color: #4F4842;
  box-shadow: 0 3px 10px rgba(0,0,0,.25);
}
/* 工具中心 · 列式菜单 */
.hub-list{ margin:10px 0; background:rgba(255,255,255,.75); border-radius:16px; overflow:hidden; border:1px solid rgba(0,0,0,.05)}
.hub-item{ display:flex; align-items:center; gap:12px; padding:14px 16px; cursor:pointer }
.hub-item + .hub-item{ border-top:1px solid rgba(0,0,0,.06) }
.hub-ico{ width:32px; height:32px; border-radius:10px; display:grid; place-items:center; background:#F8F1EB; color:#333; font-size:18px }
.hub-text{ flex:1 }
.hub-title{ font-weight:700 }
.hub-sub{ font-size:12px; opacity:.72; margin-top:2px }
.hub-go{ opacity:.45 }
body.dark .hub-list{ background:#2a2a3a; border-color:#3a3a58 }
body.dark .hub-ico{ background:#3b352f; color:#f5ece4 }
  /* —— 称呼簿（昵称库） —— */
.name-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
.guys-list{ display:flex; flex-direction:column; gap:10px; margin-top:8px }
.guy-card{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:12px; padding:10px 12px; display:flex; gap:10px; align-items:center }
.guy-main{ flex:1 }
.guy-main div{ font-weight:700 }
.guy-main small{ opacity:.72 }
.guy-actions{ display:flex; gap:8px; flex-wrap:wrap }
.guy-actions .btn.small{ padding:8px 10px; border-radius:10px }
.tip-line{ font-size:12px; opacity:.7; margin:6px 0 0 }

body.dark .guy-card{ background:#24243a; border-color:#3a3a58 }
/* —— 字体变量：让全站走 --font-app —— */
body{ font-family: var(--font-app, 'Segoe UI','Microsoft YaHei',sans-serif); }

/* 像素风可读性微调（开启像素风时会加 .font-pixel） */
.font-pixel *{ letter-spacing: 0.2px; }
/* === NameNeko · Neko（猫猫）模式 === */

/* 1) 猫耳（内嵌三角，避免 overflow:hidden 被裁切） */
.phone.neko .status-bar{ position:relative; }
.phone.neko .status-bar::before,
.phone.neko .status-bar::after{
  content:""; position:absolute; top:-8px; width:0; height:0; pointer-events:none;
  border-left:14px solid transparent; border-right:14px solid transparent;
  border-bottom:22px solid var(--accent); /* 耳朵主色：用主题强调色 */
  filter: drop-shadow(0 2px 0 rgba(0,0,0,.07));
}
.phone.neko .status-bar::before{ left:28px; transform:rotate(-8deg); }
.phone.neko .status-bar::after{ right:28px; transform:rotate(8deg); }

/* 2) 淡淡爪印背景（叠加在手机壳背景上） */
.phone.neko{
  /* 维持原有背景色/渐变，只叠一层爪印 */
  background-image:
    url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 60 60">\
<g fill="%23a88cf0" opacity="0.12">\
<circle cx="24" cy="26" r="8"/>\
<circle cx="14" cy="16" r="3.5"/><circle cx="22" cy="12" r="3.2"/><circle cx="30" cy="16" r="3.5"/><circle cx="18" cy="22" r="3.2"/>\
</g></svg>');
  background-size: 60px 60px, auto;
  background-repeat: repeat;
}

/* 3) 小爪光标（按钮/图标也跟随） */
.phone.neko,
.phone.neko .btn,
.phone.neko .app-icon{
  cursor: url('data:image/svg+xml;utf8,\
<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">\
<g fill="%232a2a2a">\
<circle cx="16" cy="20" r="6"/><circle cx="10" cy="12" r="3"/>\
<circle cx="16" cy="10" r="3"/><circle cx="22" cy="12" r="3"/><circle cx="13" cy="18" r="2"/>\
</g></svg>') 6 6, pointer;
}

/* 可选：Neko 模式里 tips 稍微更萌些 */
.phone.neko .tips{
  background: color-mix(in srgb, var(--accent) 14%, #fff);
  border-left-color: var(--accent);
}
</style>
</head>
<body>
  <div class="phone">
    <div class="status-bar">
      <div>…</div>
      <button class="btn secondary small" onclick="toggleDark()">🌓 夜间模式</button>
    </div><!-- 主界面 -->
<div id="main-screen" class="screen visible">
  <div class="icon-grid">
    <div class="app-icon" onclick="showScreen('generator-screen')">
      <img src="https://img.icons8.com/ios-filled/50/000000/edit--v1.png" alt="文本替换"/>
      <div class="app-label">替换文本</div>
    </div>
    <div class="app-icon" onclick="openLibrary()">
      <img src="https://img.icons8.com/ios-filled/50/000000/book.png" alt="心意集"/>
      <div class="app-label">心意集</div>
    </div>
    <div class="app-icon" onclick="openFavorites()">
      <img src="https://img.icons8.com/ios-filled/50/000000/like.png" alt="收藏夹"/>
      <div class="app-label">收藏夹</div>
    </div>
    <div class="app-icon" onclick="openTheme()">
      <img src="https://img.icons8.com/ios-filled/50/000000/paint-palette.png" alt="主题"/>
      <div class="app-label">主题切换</div>
    </div>
 <!-- 主界面 · 更多功能入口（改成跳工具中心） -->
<div class="app-icon" onclick="openToolsHub()">
  <img src="https://img.icons8.com/ios-filled/50/000000/menu.png" alt="其他功能"/>
  <div class="app-label">其他功能</div>
</div>
    <div class="app-icon">
      <img src="https://img.icons8.com/ios-filled/50/000000/settings--v1.png" alt="设置"/>
      <div class="app-label">设置</div>
    </div>
  </div>
</div>

<!-- 生成器屏幕 -->
<div id="generator-screen" class="screen">
  <div class="generator" id="generatorRoot">
    <div class="generator-header">
      <button class="btn secondary" onclick="showScreen('main-screen')">⬅️ 返回</button>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button class="btn secondary small" onclick="saveToLibrary(false)">💾 保存到库</button>
        <button class="btn small" onclick="saveToLibrary(true)">⭐ 保存到收藏夹</button>
      </div>
    </div>

    <div class="field">
      <label>🧾 文本标题（可选）</label>
      <input id="titleInput" placeholder="给这段文本起个标题，比如：末班车吻" />
    </div>

    <div class="row">
      <div class="field">
        <label>📝 预设名（默认 <code>yn</code>）</label>
        <input id="mainName" value="yn" />
      </div>
      <div class="field">
        <label>🌸 替换为：你的名字</label>
        <input id="newName" placeholder="输入你的名字" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>🧸 预设昵称（默认 <code>小n</code>）</label>
        <input id="mainNick" value="小n" />
      </div>
      <div class="field">
        <label>🎀 替换为：你的昵称</label>
        <input id="newNick" placeholder="输入你的昵称" />
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label>💬 预设男主名（默认 <code>hename</code>）</label>
        <input id="boyName" value="hename" />
      </div>
      <div class="field">
        <label>🖤 替换为：男主名字</label>
        <input id="boyNew" placeholder="输入男主名字" />
      </div>
    </div>

<div class="row">
      <div class="field">
        <label>🦋 预设男主昵称（默认 <code>henick</code>）</label>
        <input id="boyNick" value="henick" />
      </div>
      <div class="field">
        <label>🍷 替换为：男主昵称</label>
        <input id="boyNewnick" placeholder="输入男主昵称" />
      </div>
    </div>

    <div class="field" style="margin-top:12px;">
      <label>📖 输入你的文章：</label>
      <textarea id="inputText" rows="8" placeholder="使用占位符：yn、小n、hename、henick"></textarea>
      <div class="tips">提示：左侧为占位符（预设名/昵称），右侧为替换后的称呼。</div>
    </div>

    <div class="actions">
      <button class="btn" onclick="replaceFields()">✨ 生成代入文本</button>
      <button class="btn secondary" onclick="clearAll()">🧹 清空内容</button>
      <button class="btn" onclick="copyOutput()">📋 复制结果</button>
    </div>

    <div class="field">
      <label>🔮 你的专属乙女本：</label>
      <textarea id="outputText" rows="8" readonly></textarea>
    </div>
  </div>
</div>

<!-- 心意集 -->
<div id="library-screen" class="screen">
  <div class="generator">
    <div class="generator-header" style="gap:12px;">
      <button class="btn secondary" onclick="showScreen('main-screen')">⬅️ 返回</button>
      <strong>心意集</strong>
      <div class="lib-tools" style="flex:1;">
        <input id="libSearch" class="lib-search" placeholder="搜索标题/内容" />
        <button class="btn secondary small" onclick="renderLibrary()">🔍</button>
      </div>
    </div>
    <div id="libList" class="lib-list"></div>
    <div class="field">
      <label>📗 预览：</label>
      <textarea id="libPreview" rows="8" readonly></textarea>
    </div>
    <div class="bottom-bar">
      <button class="btn wide" onclick="exportLibraryAll()">📤 导出全部 txt</button>
    </div>
  </div>
</div>

<!-- 收藏夹（仅加星） -->
<div id="favorites-screen" class="screen">
  <div class="generator">
    <div class="generator-header" style="gap:12px;">
      <button class="btn secondary" onclick="showScreen('main-screen')">⬅️ 返回</button>
      <strong>收藏夹</strong>
      <div class="lib-tools" style="flex:1;">
        <input id="favSearch" class="lib-search" placeholder="搜索收藏内容" />
        <button class="btn secondary small" onclick="renderFavorites()">🔍</button>
      </div>
    </div>
    <div id="favList" class="lib-list"></div>
    <div class="field">
      <label>📘 预览：</label>
      <textarea id="favPreview" rows="8" readonly></textarea>
    </div>
    <div class="bottom-bar">
      <button class="btn wide" onclick="exportFavoritesAll()">📤 导出全部 txt</button>
    </div>
  </div>
</div>

<!-- 其他功能 · 分享与口令 -->
<div id="tools-screen" class="screen">
  <div class="generator">
    <div class="generator-header">
      <button class="btn secondary" onclick="showScreen('main-screen')">⬅️ 返回</button>
      <strong style="margin-left:8px">分享与口令</strong>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button class="btn secondary small" onclick="toolsFillFromGenerator()">← 从当前导入</button>
        <button class="btn secondary small" onclick="toolsClear()">🧹 清空</button>
      </div>
    </div>

    <div class="tips">把文本转成「可改名外链」或「DIJ 口令」。读者打开后会自动跳到生成器并预填。</div>

    <div class="field">
      <label>🧾 标题（可选）</label>
      <input id="toolTitle" placeholder="例如：末班车吻">
    </div>
    <div class="field">
      <label>📝 文本</label>
      <textarea id="toolText" rows="8" placeholder="把你的可替换文本粘贴到这里…支持 yn / 小n / hename / henick"></textarea>
    </div>
<!-- 口令/外链 → 文本（新增） -->
<div class="field">
  <label>🔁 或：粘贴口令/外链，解析回文本</label>
  <textarea id="toolInbound" rows="3" placeholder="在这里粘贴 DIJ 口令（DIJ1:...）或带 #data= / #dij= 的链接…"></textarea>
  <div class="actions" style="margin-top:8px">
    <button class="btn secondary small" onclick="toolsParseInbound()">🧩 解析为标题/正文</button>
    <button class="btn secondary small" onclick="toolsInboundClear()">🧹 清空口令/外链输入</button>
  </div>
</div>
    <div class="actions">
      <button class="btn small" onclick="toolsCopyGeneratorLink()">🔗 复制【可改名外链】</button>
      <button class="btn small" onclick="toolsOpenInGenerator()">🛠 打开到生成器（预填）</button>
      <button class="btn secondary small" onclick="toolsCopyDIJ()">🔒 复制【DIJ 口令】</button>
      <button class="btn secondary small" onclick="toolsImportDIJ()">📥 从剪贴板导入口令</button>
    </div>

    <div class="field">
      <label>🔍 生成结果</label>
      <input id="toolOutput" readonly style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;">
    </div>
  </div>
</div>

<!-- 工具中心（列式菜单） -->
<div id="tools-hub-screen" class="screen">
  <div class="generator">
    <div class="generator-header">
      <button class="btn secondary" onclick="showScreen('main-screen')">⬅️ 返回</button>
      <strong style="margin-left:8px">其他功能</strong>
    </div>

    <div class="hub-list">
      <div class="hub-item" onclick="openShareImport()">
        <div class="hub-ico">🔗</div>
        <div class="hub-text">
          <div class="hub-title">分享与导入</div>
          <div class="hub-sub">复制口令/外链，一键导入到生成器</div>
        </div>
        <div class="hub-go">›</div>
      </div>

      <div class="hub-item" onclick="openNickHub()">
        <div class="hub-ico">📝</div>
        <div class="hub-text">
          <div class="hub-title">称呼簿</div>
          <div class="hub-sub">可保存自己和多位男主的称呼，随时应用</div>
        </div>
        <div class="hub-go">›</div>
      </div>
    </div>
  </div>
</div>

<!-- 昵称库 · 称呼簿 -->
<div id="names-screen" class="screen">
  <div class="generator">
    <div class="generator-header" style="gap:12px;">
      <button class="btn secondary" onclick="showScreen('tools-hub-screen')">⬅️ 返回</button>
      <strong>称呼簿</strong>
      <div style="margin-left:auto;display:flex;gap:8px;">
        <button class="btn secondary small" onclick="applyUserToGenerator()">应用我的称呼</button>
      </div>
    </div>

    <!-- 我的称呼 -->
    <div class="field">
      <label>👤 我的称呼（保存后可一键填入生成器：右侧“应用我的称呼”）</label>
      <div class="name-grid">
        <div class="field">
          <label>我的大名</label>
          <input id="userNewName" placeholder="">
        </div>
        <div class="field">
          <label>我的昵称</label>
          <input id="userNewNick" placeholder="">
        </div>
      </div>
      <div class="actions">
        <button class="btn small" onclick="saveUserNames()">💾 保存我的称呼</button>
      </div>
    </div>

    <!-- 男主列表 -->
    <div class="field">
      <label>💞 男主列表（可保存多位，点星标设为常用）</label>
      <div class="name-grid">
        <div class="field">
          <label>男主名</label>
          <input id="guyNameInput" placeholder="">
        </div>
        <div class="field">
          <label>男主昵称</label>
          <input id="guyNickInput" placeholder="">
        </div>
      </div>
      <div class="actions">
        <button class="btn small" onclick="addGuy()">➕ 添加到列表</button>
      </div>

      <div id="guysList" class="guys-list"></div>
      <div class="tip-line">提示：点“应用”即可把该男主的名/昵称填到生成器（#男主名字/#男主昵称）。</div>
    </div>
  </div>
</div>

<!-- 主题切换屏幕 -->
<div id="theme-screen" class="screen">
  <div class="generator">
    <div class="generator-header">
      <button class="btn secondary" onclick="showScreen('main-screen')">⬅️ 返回</button>
      <strong style="margin-left:8px">主题切换</strong>
    </div>
    <div class="tips">选择喜欢的外观。夜间开关依旧可用；Y2K 自带深色底，但你也可以再开夜间获得更暗的面板。</div>
    <div class="theme-grid" style="display:grid; gap:12px;">
      <div class="theme-card" style="background:#eaf7fb;border:1px solid #d4eef7;border-radius:12px;padding:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#cfe9f2,#a9dbe8);"></div>
          <div style="flex:1;">
            <div style="font-weight:700">水色 · Aqua</div>
            <div style="font-size:12px;opacity:.75">清爽浅蓝，适合日常阅读</div>
          </div>
          <button class="btn small" onclick="setTheme('aqua')">应用</button>
        </div>
      </div>

      <div class="theme-card" style="background:#effaf1;border:1px solid #d8f3dc;border-radius:12px;padding:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#b7e4c7,#95d5b2);"></div>
          <div style="flex:1;">
            <div style="font-weight:700">雾绿 · Green</div>
            <div style="font-size:12px;opacity:.75">温柔绿调，眼睛很放松</div>
          </div>
          <button class="btn small" onclick="setTheme('green')">应用</button>
        </div>
      </div>

      <div class="theme-card" style="background:#0f0e1a;border:1px solid #372d74;border-radius:12px;padding:12px;color:#eee;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#8a7dff,#85f3ff);"></div>
          <div style="flex:1;">
            <div style="font-weight:700;font-family:'Orbitron','Outfit','Microsoft YaHei',sans-serif">Y2K · 霓虹</div>
            <div style="font-size:12px;opacity:.75">玻璃拟态 + 霓虹渐变，小未来感</div>
          </div>
          <button class="btn small" onclick="setTheme('y2k')">应用</button>
        </div>
      </div>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;">
      <button class="btn secondary" onclick="resetTheme()">恢复默认（粉）</button>
    </div>
<div class="actions" style="margin-top:10px;gap:8px;flex-wrap:wrap;">
  <button class="btn small" onclick="toggleNeko()">🐾 喵化开关</button>
</div>
<!-- 字体设置 -->
<div class="field" style="margin-top:12px;">
  <label>字体设置</label>
  <div class="actions" style="flex-wrap:wrap; gap:8px;">
    <button class="btn small" onclick="setFont('default')">系统默认</button>
    <button class="btn small" onclick="setFont('kawaii')">可爱风</button>
   <!-- 旧：像素风 -->
<!-- <button class="btn small" onclick="setFont('pixel')">像素风（示例）</button> -->

<!-- 新：楷体（霞鹜文楷） -->
<button class="btn small" onclick="setFont('kai')">楷体</button>
    <input id="fontFileInput" type="file" accept=".ttf,.otf,.woff,.woff2" style="display:none"
           onchange="handleFontUpload(this.files[0])">
    <button class="btn secondary small" onclick="document.getElementById('fontFileInput').click()">上传本地字体</button>
  </div>
  <div class="tips" style="margin-top:8px;">
    提示：
    上传自定义字体后，本次会话内可用；若文件较小（&lt;~2MB）会尝试保存到本地以便下次自动恢复。
  </div>
</div>
  </div>
</div>


  </div>  <script>
    /* ===== 工具 ===== */
    function showScreen(id){ document.querySelectorAll('.screen').forEach(el=>el.classList.remove('visible')); document.getElementById(id).classList.add('visible'); }
    function toggleDark(){ document.body.classList.toggle('dark'); }
    function openLibrary(){ renderLibrary(); showScreen('library-screen'); }
    function openFavorites(){ renderFavorites(); showScreen('favorites-screen'); }
    function openTheme(){ showScreen('theme-screen'); }

    function safeReg(str){ return new RegExp(str.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'); }
    function sanitizeFilename(name){ return (name||'').replace(/[\/\\?%*:|"<>]/g,'·').replace(/\s+/g,' ').trim(); }
    function ts(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`; }
    function downloadTxt(filename, content){ const blob=new Blob([content],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // 中文排版：去掉替换后出现在中英文之间的多余空格
    function tidyCJKSpaces(s){
      if(!s) return s;
      s = s.replace(/\u00A0/g,' ');
      s = s.replace(/[\t\f\v]+/g,' ');
      // 汉字-汉字
      s = s.replace(/([\u4E00-\u9FFF])\s+([\u4E00-\u9FFF])/g,'$1$2');
      // 汉字-中文标点 & 开闭口标点
      s = s.replace(/([\u4E00-\u9FFF])\s+([，。！？、；：）”’》】])/g,'$1$2');
      s = s.replace(/([（“‘《【])\s+([\u4E00-\u9FFF])/g,'$1$2');
      // 汉字-拉丁字母/数字 以及反向
      s = s.replace(/([\u4E00-\u9FFF])\s+([A-Za-z0-9]+)/g,'$1$2');
      s = s.replace(/([A-Za-z0-9])\s+([\u4E00-\u9FFF])/g,'$1$2');
      return s;
    }

    /* ===== 生成器 ===== */
    function replaceFields(){
      const mainName=(document.getElementById('mainName').value||'').trim();
      const mainNick=(document.getElementById('mainNick').value||'').trim();
      const newName=(document.getElementById('newName').value||'').trim();
      const newNick=(document.getElementById('newNick').value||'').trim();
      const boyName=(document.getElementById('boyName').value||'').trim();
      const boyNew=(document.getElementById('boyNew').value||'').trim();
      let text=(document.getElementById('inputText').value||'');
      if(mainName) text=text.replace(safeReg(mainName), newName);
      if(mainNick) text=text.replace(safeReg(mainNick), newNick);
      if(boyName)  text=text.replace(safeReg(boyName),  boyNew);
      text = tidyCJKSpaces(text); // 清理替换后左右多余空格
      document.getElementById('outputText').value=text;
    }
    function clearAll(){ document.getElementById('inputText').value=''; document.getElementById('outputText').value=''; }
    function copyOutput(){ const v=document.getElementById('outputText').value; if(!v){ alert('暂无可复制内容'); return; } if(navigator.clipboard){ navigator.clipboard.writeText(v).then(()=>alert('复制成功！')); } else { const ta=document.getElementById('outputText'); ta.select(); document.execCommand('copy'); alert('复制成功！'); } }

    /* ===== 本地库 ===== */
    const STORAGE_KEY='otomeLibraryV1';
    function getLib(){ try{ const raw=localStorage.getItem(STORAGE_KEY); return raw?JSON.parse(raw):{items:[]}; }catch(e){ return {items:[]}; } }
    function setLib(lib){ localStorage.setItem(STORAGE_KEY, JSON.stringify(lib)); }

    function saveToLibrary(starred){
      const content=(document.getElementById('outputText').value||'').trim();
      if(!content){ alert('请先生成文本再保存～'); return; }
      const rawTitle=(document.getElementById('titleInput')?.value||'').trim();
      const firstLine=content.split(/\n/).find(l=>l.trim())||'';
      const title= rawTitle || (firstLine.length>24?firstLine.slice(0,24)+'…':firstLine) || '未命名文本';
      const fields={
        mainName:document.getElementById('mainName').value||'yn',
        mainNick:document.getElementById('mainNick').value||'小n',
        boyName:document.getElementById('boyName').value||'him',
        newName:document.getElementById('newName').value||'',
        newNick:document.getElementById('newNick').value||'',
        boyNew:document.getElementById('boyNew').value||''
      };
      const lib=getLib();
      if(lib.items.some(i=>i.content===content)){ alert('这段文本已在心意集里啦～'); return; }
      const entry={ id:Date.now(), title, content, date:new Date().toISOString(), fields, starred:!!starred };
      lib.items.push(entry); setLib(lib);
      if(document.getElementById('library-screen').classList.contains('visible')) renderLibrary();
      if(document.getElementById('favorites-screen').classList.contains('visible')) renderFavorites();
      alert(starred?'已保存到收藏夹！':'已保存到心意集！');
    }

    function renderRow(i,scope){ const row=document.createElement('div'); row.className='lib-item'; row.innerHTML=`
      <button class=\"btn small ${i.starred?'':'secondary'}\" onclick=\"toggleStar(${i.id})\">${i.starred?'⭐':'☆'}</button>
      <div style=\"flex:1;min-width:0;\">
        <div class=\"lib-title\">${escapeHtml(i.title)}</div>
        <div class=\"lib-meta\">${new Date(i.id).toLocaleString()}</div>
      </div>
      <button class=\"btn small secondary\" onclick=\"previewItem(${i.id}, '${scope}')\">预览</button>
      <button class=\"btn small\" onclick=\"copyItem(${i.id})\">复制</button>
      <button class=\"btn small secondary\" onclick=\"deleteItem(${i.id})\">删除</button>`; return row; }

    function renderLibrary(){ const lib=getLib(); const q=(document.getElementById('libSearch')?.value||'').toLowerCase().trim(); const list=document.getElementById('libList'); list.innerHTML=''; let items=lib.items.slice().sort((a,b)=>b.id-a.id); if(q) items=items.filter(i=>i.title.toLowerCase().includes(q)||i.content.toLowerCase().includes(q)); if(items.length===0){ list.innerHTML='<div class="tips">暂无存档～生成后点“保存到库”试试。</div>'; return; } items.forEach(i=>list.appendChild(renderRow(i,'lib'))); }
    function renderFavorites(){ const lib=getLib(); const q=(document.getElementById('favSearch')?.value||'').toLowerCase().trim(); const list=document.getElementById('favList'); list.innerHTML=''; let items=lib.items.filter(i=>i.starred).sort((a,b)=>b.id-a.id); if(q) items=items.filter(i=>i.title.toLowerCase().includes(q)||i.content.toLowerCase().includes(q)); if(items.length===0){ list.innerHTML='<div class="tips">暂无收藏～在库里点 ☆ 变 ⭐ 或从生成器“保存到收藏夹”。</div>'; return; } items.forEach(i=>list.appendChild(renderRow(i,'fav'))); }

    function findItem(id){ const lib=getLib(); return {lib,item:lib.items.find(x=>x.id===id)} }
    function previewItem(id,scope){ const {item}=findItem(id); if(!item) return; const box= scope==='fav'? document.getElementById('favPreview') : document.getElementById('libPreview'); box.value=item.content; }
    function copyItem(id){ const {item}=findItem(id); if(!item) return; if(navigator.clipboard){ navigator.clipboard.writeText(item.content).then(()=>alert('已复制到剪贴板')); } else { const ta=document.createElement('textarea'); ta.value=item.content; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); alert('已复制到剪贴板'); } }
    function deleteItem(id){ const lib=getLib(); const idx=lib.items.findIndex(x=>x.id===id); if(idx>-1 && confirm('删除后不可恢复，确定吗？')){ lib.items.splice(idx,1); setLib(lib); renderLibrary(); renderFavorites(); const lp=document.getElementById('libPreview'); if(lp) lp.value=''; const fp=document.getElementById('favPreview'); if(fp) fp.value=''; } }
    function toggleStar(id){ const {lib,item}=findItem(id); if(!item) return; item.starred=!item.starred; setLib(lib); renderLibrary(); renderFavorites(); }

    /* ===== 导出合集（库/收藏夹） ===== */
    function exportListAsTxt(items,name){ if(!items||items.length===0){ alert(`暂无可导出的内容（${name}）`); return; } const sorted=items.slice().sort((a,b)=>a.id-b.id); const lines=sorted.map((i,idx)=>{ const when=new Date(i.id).toLocaleString(); return `# ${idx+1}. ${i.title||'未命名文本'}\n—— 日期：${when}\n\n${i.content}\n\n====================\n`; }); const bundle=lines.join('\n'); const filename=`${sanitizeFilename(name)}_${ts()}.txt`; downloadTxt(filename, bundle); }
    function exportLibraryAll(){ const lib=getLib(); exportListAsTxt(lib.items,'心意集_全部'); }
    function exportFavoritesAll(){ const lib=getLib(); exportListAsTxt(lib.items.filter(i=>i.starred),'收藏夹_全部'); }

    /* ===== 主题存取（默认不自动套主题，保留粉色原皮） ===== */
    const THEME_KEY='otomeThemeV1_theme';
    function setTheme(t, persist=true){
      document.body.classList.remove('theme-aqua','theme-green','theme-y2k');
      if(t==='aqua'||t==='green'||t==='y2k'){
        document.body.classList.add('theme-'+t);
      }
      if(persist) localStorage.setItem(THEME_KEY,t);
    }
    function resetTheme(){ localStorage.removeItem(THEME_KEY); document.body.classList.remove('theme-aqua','theme-green','theme-y2k'); }
    // 初始化：如果用户之前选过主题就还原；否则保持默认粉色，不自动变蓝
    (function initTheme(){ const t=localStorage.getItem(THEME_KEY); if(t){ setTheme(t,false); } else { resetTheme(); } })();
  </script>
<script>
if (typeof window.showScreen !== 'function') {
  window.showScreen = function(id){
    document.querySelectorAll('.screen').forEach(el=>el.classList.remove('visible'));
    const t = document.getElementById(id); if (t) t.classList.add('visible');
  };
}
if (typeof window.safeReg !== 'function') {
  window.safeReg = function(str){ return new RegExp(String(str).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'g'); };
}
function openTools(){ showScreen('tools-screen'); }

function encodePayload(obj){
  const json = JSON.stringify(obj||{});
  return btoa(unescape(encodeURIComponent(json)));
}
function decodePayload(b64){
  try{ return JSON.parse(decodeURIComponent(escape(atob(b64)))); }catch(e){ return null; }
}
function dijEncode(obj){
  const json = JSON.stringify(obj||{});
  return 'DIJ1:' + btoa(unescape(encodeURIComponent(json)));
}
function dijDecode(str){
  const m = (str||'').trim().match(/^DIJ1:\s*([\s\S]+)$/);
  if(!m) return null;
  try{ return JSON.parse(decodeURIComponent(escape(atob(m[1])))); }catch(e){ return null; }
}
/* 工具页 */
function toolsGetPayload(){ return { title:(document.getElementById('toolTitle')?.value||'').trim(), text:(document.getElementById('toolText')?.value||'') }; }
function toolsSetPayload(p){ const t1=toolTitle, t2=toolText; if(t1) t1.value=p?.title||''; if(t2) t2.value=p?.text||''; }
function toolsClear(){ toolsSetPayload({title:'',text:''}); const out=toolOutput; if(out) out.value=''; }
function toolsFillFromGenerator(){
  const title=(document.getElementById('titleInput')?.value||'').trim();
  const text =(document.getElementById('inputText') ?.value||'');
  toolsSetPayload({title,text}); alert('已从生成器带入当前内容');
}
function toolsCopyGeneratorLink(){
  const {title,text}=toolsGetPayload(); if(!text.trim()) return alert('请先粘贴文本');
  const base = location.origin + location.pathname;
  const url  = `${base}#data=${encodePayload({title,text})}`;
  if(toolOutput) toolOutput.value=url;
  if(navigator.clipboard) navigator.clipboard.writeText(url).then(()=>alert('可改名外链已复制'));
  else { const ta=document.createElement('textarea'); ta.value=url; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('可改名外链已复制'); }
}
function toolsCopyDIJ(){
  const {title,text}=toolsGetPayload(); if(!text.trim()) return alert('请先粘贴文本');
  const token=dijEncode({title,text}); if(toolOutput) toolOutput.value=token;
  if(navigator.clipboard) navigator.clipboard.writeText(token).then(()=>alert('DIJ 口令已复制'));
  else { const ta=document.createElement('textarea'); ta.value=token; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('DIJ 口令已复制'); }
}
async function toolsImportDIJ(){
  try{
    const t = await navigator.clipboard.readText();
    const obj = dijDecode(t); if(!obj) return alert('剪贴板里没有识别到 DIJ 口令');
    toolsSetPayload(obj); alert('已导入口令内容到工具页');
  }catch(e){ alert('无法读取剪贴板，请手动粘贴到文本框里~'); }
}
function toolsOpenInGenerator(){
  const {title,text}=toolsGetPayload(); if(!text.trim()) return alert('请先粘贴文本');
  const ti=titleInput, tx=inputText; if(ti) ti.value=title||''; if(tx) tx.value=text;
  showScreen('generator-screen'); setTimeout(()=>{ tx?.scrollIntoView({behavior:'smooth',block:'start'}); },0);
}

/* 支持 #data= / #dij= 打开即跳到生成器并预填 */
(function preloadFromHash(){
  const h=location.hash||'';
  const mDij=h.match(/#(?:.*&)?dij=([^&]+)/);
  if(mDij){ const raw=decodeURIComponent(mDij[1]); const obj=dijDecode(raw);
    if(obj){ (titleInput||{}).value=obj.title||''; (inputText||{}).value=obj.text||''; showScreen('generator-screen'); return; } }
  const m=h.match(/#(?:.*&)?data=([^&]+)/);
  if(m){ const obj=decodePayload(m[1]);
    if(obj){ (titleInput||{}).value=obj.title||''; (inputText||{}).value=obj.text||''; showScreen('generator-screen'); } }
})();

/* 覆盖 replaceFields：加入 hename/henick */
function replaceFields(){
  const textIn=(inputText?.value||''); const pairs=[];
  const mainName=(mainName?.value||document.getElementById('mainName')?.value||'').trim();
  const newName =(newName ?.value||document.getElementById('newName') ?.value||'').trim();
  const mainNick=(mainNick?.value||document.getElementById('mainNick')?.value||'').trim();
  const newNick =(newNick ?.value||document.getElementById('newNick') ?.value||'').trim();
  const boyName =(boyName ?.value||document.getElementById('boyName') ?.value||'').trim();   // hename
  const boyNew  =(boyNew  ?.value||document.getElementById('boyNew')  ?.value||'').trim();
  const boyNick =(boyNick ?.value||document.getElementById('boyNick') ?.value||'').trim();   // henick
  const boyNewN =(boyNewnick?.value||document.getElementById('boyNewnick')?.value||'').trim();if(mainName) pairs.push([mainName,newName]);
  if(mainNick) pairs.push([mainNick,newNick]);
  if(boyName)  pairs.push([boyName,boyNew]);
  if(boyNick)  pairs.push([boyNick,boyNewN]);
  pairs.sort((a,b)=>b[0].length-a[0].length);

  let out=textIn; for(const [f,t] of pairs){ out=out.replace(safeReg(f),t); }
  if(typeof tidyCJKSpaces==='function'){ out=tidyCJKSpaces(out); }
  else { out=out.replace(/\u00A0/g,' ').replace(/\s+([，。！？、；：）”’》】])/g,'$1').replace(/([（“‘《【])\s+/g,'$1'); }
  document.getElementById('outputText').value=out;
}
</script>
<script>
/* 兜底：解析 DIJ 口令 / #data= / #dij= 的通用函数（已有则跳过） */
if (typeof window.parseShareText !== 'function') {
  window.parseShareText = function(t){
    if(!t) return null;
    // 1) DIJ 口令
    const m1 = t.match(/^DIJ1:\s*([\s\S]+)$/);
    if(m1){ try{
      const obj = JSON.parse(decodeURIComponent(escape(atob(m1[1]))));
      return {title: obj.title||'', text: obj.text||''};
    }catch(e){} }

    // 2) 链接里 #data=
    const m2 = t.match(/#(?:.*&)?data=([^&\s]+)/);
    if(m2){ try{
      const obj = JSON.parse(decodeURIComponent(escape(atob(m2[1]))));
      return {title: obj.title||'', text: obj.text||''};
    }catch(e){} }

    // 3) 链接里 #dij=（内含 DIJ1:xxx）
    const m3 = t.match(/#(?:.*&)?dij=([^&\s]+)/);
    if(m3){ try{
      const raw = decodeURIComponent(m3[1]);
      const m = raw.match(/^DIJ1:\s*([\s\S]+)$/);
      if(m){ const obj = JSON.parse(decodeURIComponent(escape(atob(m[1]))));
             return {title: obj.title||'', text: obj.text||''}; }
    }catch(e){} }

    // 4) 兜底：看起来像 base64 的纯负载也试试
    if(/^[A-Za-z0-9+/=]+$/.test(t.trim())){ try{
      const obj = JSON.parse(decodeURIComponent(escape(atob(t.trim()))));
      if(obj && (obj.text||obj.title)) return {title: obj.title||'', text: obj.text||''};
    }catch(e){} }

    return null;
  };
}

/* 工具页：解析入口 */
function toolsParseInbound(){
  const inbound = (document.getElementById('toolInbound')?.value||'').trim();
  if(!inbound){ alert('请先粘贴口令或外链'); return; }
  const res = parseShareText(inbound);
  if(!res){ alert('未识别到有效的口令/外链'); return; }
  // 填回标题/正文输入框
  const t1 = document.getElementById('toolTitle');
  const t2 = document.getElementById('toolText');
  if(t1) t1.value = res.title || '';
  if(t2) t2.value = res.text  || '';
  // 视觉反馈
  document.getElementById('toolInbound').style.outline = '2px solid rgba(76,175,80,.6)';
  setTimeout(()=>{ document.getElementById('toolInbound').style.outline = 'none'; }, 1000);
  alert('已解析为标题/正文，可继续生成外链或直接打开到生成器');
}
function toolsInboundClear(){
  const el = document.getElementById('toolInbound');
  if(el){ el.value=''; el.style.outline='none'; }
}

/* 可选：用户粘贴时自动尝试解析（解析成功会填充文本区） */
document.getElementById('toolInbound')?.addEventListener('paste', (e)=>{
  setTimeout(()=>{    // 等内容进来再解析
    const v = e.target.value.trim();
    const res = parseShareText(v);
    if(res){
      const t1 = document.getElementById('toolTitle');
      const t2 = document.getElementById('toolText');
      if(t1) t1.value = res.title || '';
      if(t2) t2.value = res.text  || '';
      e.target.style.outline = '2px solid rgba(76,175,80,.6)';
      setTimeout(()=>{ e.target.style.outline='none'; }, 1000);
    }
  },0);
});
</script>
<script>
/* 安全替换：不会用到与 ID 同名的变量，避免 ReferenceError */
function replaceFields(){
  try{
    const get = id => (document.getElementById(id)?.value || '').trim();
    const textIn = (document.getElementById('inputText')?.value || '');

    // from → to 列表（只要 from 存在；to 为空就不替换）
    const pairs = [
      [get('mainName'), get('newName')],     // yn -> 你的名字
      [get('mainNick'), get('newNick')],     // 小n -> 你的昵称
      [get('boyName') , get('boyNew')],      // hename -> 男主名
      [get('boyNick') , get('boyNewnick')],  // henick  -> 男主昵称
    ].filter(([from,to]) => from && to !== '');

    // 长词优先，避免子串误替
    pairs.sort((a,b)=> b[0].length - a[0].length);

    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    let out = textIn;
    for(const [from,to] of pairs){
      out = out.replace(new RegExp(esc(from), 'g'), to);
    }

    // 简单的中英文空格清理
    out = out.replace(/\u00A0/g,' ')
             .replace(/\s+([，。！？、；：）”’》】])/g,'$1')
             .replace(/([（“‘《【])\s+/g,'$1');

    const outBox = document.getElementById('outputText');
    if(outBox) outBox.value = out;
    else showToast('找不到 #outputText 文本框');
  }catch(err){
    showToast('生成失败：' + err.message);
    console.error(err);
  }
}

/* 小提示气泡（可选） */
function showToast(msg){
  const d=document.createElement('div');
  d.textContent=msg;
  Object.assign(d.style,{
    position:'fixed',left:'50%',bottom:'16px',transform:'translateX(-50%)',
    background:'rgba(0,0,0,.7)',color:'#fff',padding:'8px 12px',
    borderRadius:'10px',zIndex:9999,fontSize:'14px'
  });
  document.body.appendChild(d); setTimeout(()=>d.remove(),1800);
}
</script>
<script>
/* —— 更强版：生成 + 中文排版清理 —— */
function replaceFields(){
  try{
    const get = id => (document.getElementById(id)?.value || '').trim();
    const textIn = (document.getElementById('inputText')?.value || '');

    // from → to（只有 from 有值时才参与；to 允许空串 = 强制清掉）
    const pairs = [
      [get('mainName'), get('newName')],     // yn
      [get('mainNick'), get('newNick')],     // 小n
      [get('boyName') , get('boyNew')],      // hename
      [get('boyNick') , get('boyNewnick')],  // henick
    ].filter(([from]) => !!from);

    // 长词优先，避免子串误替
    pairs.sort((a,b)=> b[0].length - a[0].length);

    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    let out = textIn;
    for(const [from,to] of pairs){
      out = out.replace(new RegExp(esc(from), 'g'), to);
    }

    // 中文排版清理（去掉多余空格/标点两侧空格/首尾空格/多余空行）
    out = tidyCJKSpacesPro(out);

    const outBox = document.getElementById('outputText');
    if(outBox) outBox.value = out;
    else showToast('找不到 #outputText 文本框');
  }catch(err){
    showToast('生成失败：' + err.message);
    console.error(err);
  }
}

/* 适配中英文的空格清理（尽量“只动该动的”） */
function tidyCJKSpacesPro(s){
  if(!s) return s;
  // 统一空白
  s = s.replace(/\u00A0/g,' ').replace(/\t+/g,'\t');
  // 中文之间不留空格
  s = s.replace(/([\u4E00-\u9FFF])\s+([\u4E00-\u9FFF])/g,'$1$2');
  // 开合引号/括号：去掉开后空格、关前空格
  s = s.replace(/([（【《「『“])\s+/g,'$1')
       .replace(/\s+([）】》」』”])/g,'$1');
  // 中文标点前不留空格
  s = s.replace(/\s+([，。！？、；：…—])/g,'$1');
  // 西文词汇：把多空格压成单空格（不破坏英文排版）
  s = s.replace(/([A-Za-z0-9])\s{2,}([A-Za-z0-9])/g,'$1 $2');
  // 每行首尾空格
  s = s.replace(/[ \t]+$/gm,'').replace(/^[ \t]+/gm,'');
  // 连续空行最多保留一个
  s = s.replace(/\n{3,}/g,'\n\n');
  // 全文首尾
  return s.trim();
}

/* 小提示气泡（可选） */
function showToast(msg){
  const d=document.createElement('div');
  d.textContent=msg;
  Object.assign(d.style,{
    position:'fixed',left:'50%',bottom:'16px',transform:'translateX(-50%)',
    background:'rgba(0,0,0,.7)',color:'#fff',padding:'8px 12px',
    borderRadius:'10px',zIndex:9999,fontSize:'14px'
  });
  document.body.appendChild(d); setTimeout(()=>d.remove(),1800);
}
</script>
<script>
function openToolsHub(){ showScreen('tools-hub-screen'); }

function openShareImport(){
  if(document.getElementById('tools-screen')){
    showScreen('tools-screen');
    const h = document.querySelector('#tools-screen .generator-header strong');
    if(h) h.textContent = '分享与导入';
  }else{
    alert('没找到分享页（tools-screen）。请把你的分享页 id 改成 tools-screen。');
  }
}

function openNickHub(){
  if(document.getElementById('names-screen')){
    showScreen('names-screen');
    const h = document.querySelector('#names-screen .generator-header strong');
    if(h) h.textContent = '称呼簿';
  }else{
    alert('没找到称呼簿页面（names-screen）。');
  }
}
</script>
<script>
// —— 数据键 —— 
const KEY_USER = 'otomeUserDefaultV1';  // { newName, newNick }
const KEY_GUYS = 'otomeGuysV1';         // [{id,name,nick,fav}]

// —— 工具 —— 
function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY_USER)||'null') || {newName:'',newNick:''}; }catch(e){ return {newName:'',newNick:''}; } }
function saveUser(obj){ try{ localStorage.setItem(KEY_USER, JSON.stringify(obj)); }catch(e){} }
function loadGuys(){ try{ return JSON.parse(localStorage.getItem(KEY_GUYS)||'[]'); }catch(e){ return []; } }
function saveGuys(arr){ try{ localStorage.setItem(KEY_GUYS, JSON.stringify(arr)); }catch(e){} }

function saveUserNames(){
  const newName = (document.getElementById('userNewName')?.value||'').trim();
  const newNick = (document.getElementById('userNewNick')?.value||'').trim();
  saveUser({newName,newNick});
  alert('已保存我的称呼');
}
function loadUserNamesIntoInputs(){
  const u = loadUser();
  const a = document.getElementById('userNewName'); if(a) a.value = u.newName||'';
  const b = document.getElementById('userNewNick'); if(b) b.value = u.newNick||'';
}
function applyUserToGenerator(){
  const u = loadUser();
  const a = document.getElementById('newName'); if(a) a.value = u.newName||'';
  const b = document.getElementById('newNick'); if(b) b.value = u.newNick||'';
  if(typeof showScreen==='function') showScreen('generator-screen');
  alert('已应用我的称呼到生成器');
}

// —— 男主 CRUD —— 
function addGuy(){
  const name = (document.getElementById('guyNameInput')?.value||'').trim();
  const nick = (document.getElementById('guyNickInput')?.value||'').trim();
  if(!name && !nick){ alert('至少填写一个'); return; }
  const list = loadGuys();
  list.unshift({ id: Date.now(), name, nick, fav:false });
  saveGuys(list);
  document.getElementById('guyNameInput').value='';
  document.getElementById('guyNickInput').value='';
  renderGuys();
}
function delGuy(id){
  saveGuys(loadGuys().filter(g=>g.id!==id)); renderGuys();
}
function toggleFav(id){
  saveGuys(loadGuys().map(g=> g.id===id ? {...g, fav:!g.fav} : g)); renderGuys();
}
function editGuy(id){
  const list = loadGuys();
  const g = list.find(x=>x.id===id); if(!g) return;
  const name = prompt('编辑男主名：', g.name||''); if(name===null) return;
  const nick = prompt('编辑男主昵称：', g.nick||''); if(nick===null) return;
  g.name = name.trim(); g.nick = nick.trim();
  saveGuys(list); renderGuys();
}
function applyGuy(id){
  const g = loadGuys().find(x=>x.id===id); if(!g) return;
  const a = document.getElementById('boyNew');     if(a) a.value = g.name||'';
  const b = document.getElementById('boyNewnick'); if(b) b.value = g.nick||'';
  if(typeof showScreen==='function') showScreen('generator-screen');
  alert('已应用男主到生成器');
}

function renderGuys(){
  const box = document.getElementById('guysList'); if(!box) return;
  const list = loadGuys();
  if(list.length===0){ box.innerHTML = '<div class="tips">暂无男主，先在上方添加一位吧。</div>'; return; }
  box.innerHTML = '';
  list.forEach(g=>{
    const div = document.createElement('div'); div.className='guy-card';
    div.innerHTML = `
      <div class="hub-ico" style="font-size:16px">${g.fav?'⭐':'💙'}</div>
      <div class="guy-main">
        <div>${g.name || '（未填名）'}</div>
        <small>昵称：${g.nick || '—'}</small>
      </div>
      <div class="guy-actions">
        <button class="btn small" onclick="applyGuy(${g.id})">应用</button>
        <button class="btn secondary small" onclick="toggleFav(${g.id})">${g.fav?'取消星标':'设为常用'}</button>
        <button class="btn secondary small" onclick="editGuy(${g.id})">编辑</button>
        <button class="btn secondary small" onclick="delGuy(${g.id})">删除</button>
      </div>`;
    box.appendChild(div);
  });
}

// 进入“称呼簿”时自动渲染与回填
(function(){
  const _show = window.showScreen;
  window.showScreen = function(id){
    if(typeof _show==='function') _show(id);
    document.querySelectorAll('.screen').forEach(el=>el.classList.remove('visible'));
    const s = document.getElementById(id); if(s) s.classList.add('visible');
    if(id==='names-screen'){ loadUserNamesIntoInputs(); renderGuys(); }
  };
})();
</script>
<script>
function ensureLink(href, id){
  let link = document.getElementById(id);
  if(!link){
    link = document.createElement('link');
    link.rel = 'stylesheet'; link.id = id; link.href = href;
    document.head.appendChild(link);
  }
}
function addFontFace(family, srcUrl, formatHint){
  const id = 'ff-'+family.replace(/\W+/g,'');
  if(document.getElementById(id)) return;
  const st = document.createElement('style'); st.id = id;
  const fmt = formatHint || (/\.(woff2)\b/i.test(srcUrl)?'woff2':/\.(woff)\b/i.test(srcUrl)?'woff':/\.(otf)\b/i.test(srcUrl)?'opentype':'truetype');
  st.textContent = `@font-face{ font-family:'${family}'; src:url('${srcUrl}') format('${fmt}'); font-display:swap; }`;
  document.head.appendChild(st);
}

/* —— 无弹窗切换字体 —— */
function setFont(name){
  const root = document.documentElement;

  // 统一清理任何旧的状态类（如果你之前给像素风加过 .font-pixel，可以删掉那段用不到了）
  document.body.classList.remove('font-pixel');

  if(name === 'default'){
    root.style.setProperty('--font-app', `'Segoe UI','Microsoft YaHei',sans-serif`);
    try{ localStorage.setItem('otomeFont','default'); localStorage.removeItem('otomeFontData'); }catch(e){}
    return;
  }

  if(name === 'kawaii'){
    // 站酷快乐体（支持中文）
    ensureLink('https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap','fontZcool');
    root.style.setProperty('--font-app', `'ZCOOL KuaiLe','Microsoft YaHei','Segoe UI',sans-serif`);
    try{ localStorage.setItem('otomeFont','kawaii'); localStorage.removeItem('otomeFontData'); }catch(e){}
    return;
  }

  if(name === 'kai'){
    // 楷体：霞鹜文楷（Web 字体）
    // 轻量引入整套 CSS（已包含 @font-face），family 名为 "LXGW WenKai"
    ensureLink('https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont/style.css','fontLXGW');
    root.style.setProperty('--font-app', `'LXGW WenKai','Kaiti','KaiTi','Kaiti SC','STKaiti','Microsoft YaHei','Segoe UI',sans-serif`);
    try{ localStorage.setItem('otomeFont','kai'); localStorage.removeItem('otomeFontData'); }catch(e){}
    return;
  }

  if(name === 'custom'){
    // 自定义（先由 handleFontUpload 注入 @font-face: 'UserCustomFont'）
    root.style.setProperty('--font-app', `'UserCustomFont','Microsoft YaHei','Segoe UI',sans-serif`);
    try{ localStorage.setItem('otomeFont','custom'); }catch(e){}
    return;
  }
}

</script>
<script>
// ---- 固定键名（与之前保持一致） ----
const KEY_USER = 'otomeUserDefaultV1';  // { newName, newNick }
const KEY_GUYS = 'otomeGuysV1';         // [{id,name,nick,fav}]

// ---- 安全读写 ----
function sget(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch(e){ return fallback; }
}
function sset(key, val){
  try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){}
}

// ---- 你现有的保存/读取（若已实现可删重） ----
function loadUser(){ return sget(KEY_USER, {newName:'', newNick:''}); }
function saveUser(obj){ sset(KEY_USER, obj); }
function loadGuys(){ return sget(KEY_GUYS, []); }
function saveGuys(arr){ sset(KEY_GUYS, arr); }

// ---- 回填 + 自动保存（进入“称呼簿”或刷新时执行）----
function rehydrateNamesScreen(){
  // 回填“我的称呼”
  const u = loadUser();
  const a = document.getElementById('userNewName');
  const b = document.getElementById('userNewNick');
  if(a && a !== document.activeElement) a.value = u.newName || '';
  if(b && b !== document.activeElement) b.value = u.newNick || '';

  // 绑定自动保存（只绑定一次）
  if(a && !a._autosaveBound){
    a._autosaveBound = true;
    a.addEventListener('input', debounce(()=>{
      const nv = (document.getElementById('userNewName')?.value||'').trim();
      const nn = (document.getElementById('userNewNick')?.value||'').trim();
      saveUser({ newName:nv, newNick:nn });
    }, 200));
  }
  if(b && !b._autosaveBound){
    b._autosaveBound = true;
    b.addEventListener('input', debounce(()=>{
      const nv = (document.getElementById('userNewName')?.value||'').trim();
      const nn = (document.getElementById('userNewNick')?.value||'').trim();
      saveUser({ newName:nv, newNick:nn });
    }, 200));
  }

  // 渲染男主列表（复用你已有的 renderGuys；没有的话给一个兜底）
  if(typeof renderGuys === 'function'){ renderGuys(); }
  else {
    const box = document.getElementById('guysList');
    const list = loadGuys();
    if(box){
      box.innerHTML = list.length ? list.map(g=>`
        <div class="guy-card">
          <div class="hub-ico" style="font-size:16px">${g.fav?'⭐':'💙'}</div>
          <div class="guy-main">
            <div>${g.name || '（未填名）'}</div>
            <small>昵称：${g.nick || '—'}</small>
          </div>
        </div>`).join('') : '<div class="tips">暂无男主，先在上方添加一位吧。</div>';
    }
  }
}

// ---- 软挂钩 showScreen（不破坏你原逻辑）----
(function hookShowScreen(){
  const prev = window.showScreen;
  window.showScreen = function(id){
    // 调用你自己的
    if(typeof prev === 'function'){ prev(id); }
    // 稍后做回填（避免和你的 DOM 切屏打架）
    setTimeout(()=>{
      if(id === 'names-screen'){ rehydrateNamesScreen(); }
    }, 0);
  };
})();

// ---- 页面加载时也回填一次（用户直接刷在“称呼簿”上时）----
window.addEventListener('DOMContentLoaded', ()=>{
  if(document.getElementById('names-screen')){ rehydrateNamesScreen(); }
});

// ---- 小工具：防抖 ----
function debounce(fn, delay){ let t; return function(){ clearTimeout(t); t=setTimeout(fn,delay); }; }

// ---- 你已有的按钮函数（若未实现，可以保留这些最小实现）----
if(typeof saveUserNames !== 'function'){
  window.saveUserNames = function(){
    const newName = (document.getElementById('userNewName')?.value||'').trim();
    const newNick = (document.getElementById('userNewNick')?.value||'').trim();
    saveUser({ newName, newNick });
  };
}
if(typeof addGuy !== 'function'){
  window.addGuy = function(){
    const name = (document.getElementById('guyNameInput')?.value||'').trim();
    const nick = (document.getElementById('guyNickInput')?.value||'').trim();
    if(!name && !nick) return;
    const list = loadGuys();
    list.unshift({ id: Date.now(), name, nick, fav:false });
    saveGuys(list);
    const ni=document.getElementById('guyNameInput'); if(ni) ni.value='';
    const nk=document.getElementById('guyNickInput'); if(nk) nk.value='';
    rehydrateNamesScreen();
  };
}
</script>
<script>
/* =========================
   生成器称呼 · 本地持久化（最小增量）
   - 自动保存/回填 #newName #newNick #boyNew #boyNewnick
   - 进入 generator-screen 或刷新时自动回填
   - 兼容你已有的 showScreen / applyGuy
   ========================= */

const KEY_USER = 'otomeUserDefaultV1';   // { newName, newNick }
const KEY_GUYS = 'otomeGuysV1';          // [{id,name,nick,fav}]
const KEY_GUY_DEFAULT = 'otomeGuyDefaultV1'; // { name, nick } 生成器默认男主

// 安全读写
function sget(key, fallback){ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fallback; }catch(e){ return fallback; } }
function sset(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }

// —— 持久化：我的称呼（女主）
function saveUserDefaultsFromInputs(){
  const nn = (document.getElementById('newName')?.value||'').trim();
  const nk = (document.getElementById('newNick')?.value||'').trim();
  const cur = sget(KEY_USER, {newName:'', newNick:''});
  if(cur.newName!==nn || cur.newNick!==nk){
    sset(KEY_USER, { newName: nn, newNick: nk });
  }
}
// —— 持久化：男主默认
function saveGuyDefaultFromInputs(){
  const gn = (document.getElementById('boyNew')?.value||'').trim();
  const gk = (document.getElementById('boyNewnick')?.value||'').trim();
  const cur = sget(KEY_GUY_DEFAULT, {name:'', nick:''});
  if(cur.name!==gn || cur.nick!==gk){
    sset(KEY_GUY_DEFAULT, { name: gn, nick: gk });
  }
}

// —— 回填生成器输入框
function hydrateGeneratorNames(){
  const u = sget(KEY_USER, {newName:'', newNick:''});
  const d = sget(KEY_GUY_DEFAULT, {name:'', nick:''});

  const a = document.getElementById('newName');
  const b = document.getElementById('newNick');
  const c = document.getElementById('boyNew');
  const d2= document.getElementById('boyNewnick');

  if(a) a.value = u.newName || a.value || '';
  if(b) b.value = u.newNick || b.value || '';
  if(c) c.value = d.name    || c.value || '';
  if(d2)d2.value= d.nick    || d2.value|| '';

  // 绑定自动保存（只绑定一次）
  if(a && !a._bindSave){ a._bindSave=true; a.addEventListener('input', saveUserDefaultsFromInputs); }
  if(b && !b._bindSave){ b._bindSave=true; b.addEventListener('input', saveUserDefaultsFromInputs); }
  if(c && !c._bindSave){ c._bindSave=true; c.addEventListener('input', saveGuyDefaultFromInputs); }
  if(d2&& !d2._bindSave){ d2._bindSave=true; d2.addEventListener('input', saveGuyDefaultFromInputs); }
}

// —— 软挂钩 showScreen：进入生成器页时回填
(function(){
  const prev = window.showScreen;
  window.showScreen = function(id){
    if(typeof prev==='function') prev(id);
    // 让你的原切屏先生效，再回填
    setTimeout(()=>{ if(id==='generator-screen') hydrateGeneratorNames(); }, 0);
  };
})();

// —— 软扩展 applyGuy：在“称呼簿”里点“应用男主”时，顺便记为默认
(function(){
  const prevApply = window.applyGuy;
  window.applyGuy = function(id){
    if(typeof prevApply==='function') prevApply(id);
    // 尝试从男主列表找到条目并保存为默认
    try{
      const list = sget(KEY_GUYS, []);
      const g = list.find(x=>x.id===id);
      if(g){
        sset(KEY_GUY_DEFAULT, { name:(g.name||'').trim(), nick:(g.nick||'').trim() });
      }
    }catch(e){}
    // 同时把当前生成器输入框也保存一次（防止别的逻辑覆盖）
    setTimeout(saveGuyDefaultFromInputs, 0);
  };
})();

// —— 首次进入页面时，如果一上来就在生成器页，也回填一次
window.addEventListener('DOMContentLoaded', ()=>{
  hydrateGeneratorNames();
});

// （可选）提供一个清空默认的工具函数
window.clearGeneratorDefaults = function(){
  try{ localStorage.removeItem(KEY_USER); localStorage.removeItem(KEY_GUY_DEFAULT); }catch(e){}
  ['newName','newNick','boyNew','boyNewnick'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
};
</script>
<script>
function toggleNeko(force){
  const phone = document.querySelector('.phone'); if(!phone) return;
  if(typeof force === 'boolean'){ phone.classList.toggle('neko', force); }
  else{ phone.classList.toggle('neko'); }
  try{ localStorage.setItem('nekoMode', phone.classList.contains('neko') ? '1' : '0'); }catch(e){}
}
// 首次进入恢复上次选择
window.addEventListener('DOMContentLoaded', ()=>{
  try{
    if(localStorage.getItem('nekoMode') === '1'){ toggleNeko(true); }
  }catch(e){}
});
</script>
</body>
</html>